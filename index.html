<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark light">
    <title>Prototipo - Gestión Escolar Premium</title>

    <!-- Preconnects -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

    <!-- Google Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com" defer></script>

    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <!-- Lottie Player CDN -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js" defer></script>
    <!-- SheetJS (XLSX/CSV parser) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

    <!-- Evitar FOUC del tema: setear clase dark/light antes del paint -->
    <script>
      (function() {
        try {
          const saved = localStorage.getItem('ui-theme');
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          const isDark = saved ? saved === 'dark' : prefersDark;
          const root = document.documentElement;
          if (isDark) root.classList.add('dark'); else root.classList.remove('dark');
        } catch (e) {}
      })();
    </script>

    <style>
        :root {
            --bg-primary-light: #F8F9FC;
            --bg-surface-light: #FFFFFF;
            --text-primary-light: #111726;
            --text-secondary-light: #6B7280;
            --border-default-light: #E5E7EB;
            --accent-1-light: #3EBBAF;
            --accent-2-light: #9F80F8;
            --status-error-light: #EF4444;
            --status-success-light: #10B981;
            --status-warning-light: #F59E0B;
        }
        .dark:root {
            --bg-primary-dark: #0B0F1A;
            --bg-surface-dark: #111726;
            --text-primary-dark: #E6EAF2;
            --text-secondary-dark: #9CA3AF;
            --border-default-dark: #374151;
            --accent-1-dark: #4FD1C5;
            --accent-2-dark: #A78BFA;
            --status-error-dark: #F87171;
            --status-success-dark: #34D399;
            --status-warning-dark: #FBBF24;
        }
        body {
            font-family: 'Inter', sans-serif;
            --bg-primary: var(--bg-primary-light);
            --bg-surface: var(--bg-surface-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border-default: var(--border-default-light);
            --accent-1: var(--accent-1-light);
            --accent-2: var(--accent-2-light);
            --status-error: var(--status-error-light);
            --status-success: var(--status-success-light);
            --status-warning: var(--status-warning-light);
        }
        .dark body {
            --bg-primary: var(--bg-primary-dark);
            --bg-surface: var(--bg-surface-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-default: var(--border-default-dark);
            --accent-1: var(--accent-1-dark);
            --accent-2: var(--accent-2-dark);
            --status-error: var(--status-error-dark);
            --status-success: var(--status-success-dark);
            --status-warning: var(--status-warning-dark);
        }
        .bg-primary { background-color: var(--bg-primary); }
        .bg-surface { background-color: var(--bg-surface); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-default { border-color: var(--border-default); }
        .text-accent-1 { color: var(--accent-1); }
        .bg-accent-1 { background-color: var(--accent-1); }
        .text-accent-2 { color: var(--accent-2); }
        .bg-accent-2 { background-color: var(--accent-2); }
        .text-error { color: var(--status-error); }
        .border-error { border-color: var(--status-error); }
        .text-success { color: var(--status-success); }
        .text-warning { color: var(--status-warning); }
        .ring-accent-1 { --tw-ring-color: var(--accent-1); }
        .ring-accent-2 { --tw-ring-color: var(--accent-2); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background-color: var(--border-default); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
        .attendance-radio-group input[type="radio"] { display: none; }
        .attendance-radio-group label { cursor: pointer; display: inline-block; width: 2.25rem; height: 2.25rem; line-height: 2.25rem; text-align: center; font-weight: 500; border-radius: 9999px; border: 2px solid var(--border-default); color: var(--text-secondary); transition: all 150ms ease-in-out; }
        .attendance-radio-group input[type="radio"]:checked + label { color: white; border-color: transparent; }
        .attendance-radio-group input[value="P"]:checked + label { background-color: #10B981; }
        .attendance-radio-group input[value="F"]:checked + label { background-color: #EF4444; }
        .attendance-radio-group input[value="R"]:checked + label { background-color: #F59E0B; }
        .attendance-radio-group input[value="J"]:checked + label { background-color: #3B82F6; }
        .attendance-radio-group label:hover { transform: scale(1.1); }
        .step-item { display: flex; align-items: center; color: var(--text-secondary); transition: all 300ms ease; }
        .step-item.active { color: var(--accent-2); font-weight: 600; }
        .step-item.completed { color: var(--text-primary); }
        .step-item .step-circle { width: 2.5rem; height: 2.5rem; border-radius: 9999px; border: 2px solid var(--border-default); display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 0.75rem; transition: all 300ms ease; }
        .step-item.active .step-circle { border-color: var(--accent-2); background-color: var(--accent-2); color: white; }
        .step-item.completed .step-circle { border-color: var(--accent-1); background-color: var(--accent-1); color: white; }
        .step-connector { flex-grow: 1; height: 2px; background-color: var(--border-default); margin: 0 1rem; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 500; color: var(--text-secondary); transition: all 150ms ease-in-out; white-space: nowrap; }
        .nav-link:hover { background-color: var(--bg-primary); color: var(--text-primary); }
        .nav-link.active { background-color: var(--bg-primary); color: var(--accent-1); font-weight: 600; }
        .nav-link [data-lucide] { width: 1.25rem; height: 1.25rem; margin-right: 1rem; flex-shrink: 0; }
        #sidebar.w-20 .nav-link { justify-content: center; padding: 0.75rem; }
        #sidebar.w-20 .nav-link [data-lucide] { margin-right: 0; }
        #sidebar.w-20 .sidebar-text { display: none; }
        #sidebar.w-20 .h-20 { justify-content: center; padding-left: 0; padding-right: 0; }
        #sidebar.w-20 .h-20 .sidebar-text { display: none; }
    </style>
</head>
<body class="bg-primary text-primary antialiased">

    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar" class="w-64 bg-surface border-r border-default flex flex-col transition-all duration-300 ease-in-out overflow-y-auto">
            <div class="h-20 flex items-center px-6 shrink-0">
                <i data-lucide="graduation-cap" class="text-accent-1" stroke-width="2.5"></i>
                <span class="text-xl font-bold ml-3 text-primary sidebar-text">Escolar<span class="text-accent-1">.io</span></span>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" class="nav-link" data-page="dashboard"><i data-lucide="layout-grid"></i><span class="sidebar-text">Dashboard</span></a>
                <a href="#" class="nav-link" data-page="estudiantes"><i data-lucide="users"></i><span class="sidebar-text">Estudiantes</span></a>
                <a href="#" class="nav-link" data-page="grupos"><i data-lucide="book-copy"></i><span class="sidebar-text">Grupos y Materias</span></a>
                <a href="#" class="nav-link" data-page="asistencias"><i data-lucide="calendar-check"></i><span class="sidebar-text">Tomar Asistencia</span></a>
                <a href="#" class="nav-link" data-page="calificaciones"><i data-lucide="file-check-2"></i><span class="sidebar-text">Calificaciones</span></a>
                <a href="#" class="nav-link" data-page="importar"><i data-lucide="upload-cloud"></i><span class="sidebar-text">Importar Datos</span></a>
                <a href="#" class="nav-link" data-page="reportes"><i data-lucide="pie-chart"></i><span class="sidebar-text">Reportes</span></a>
            </nav>
            <div class="p-4 border-t border-default shrink-0">
                <a href="#" class="nav-link" data-page="admin"><i data-lucide="settings"></i><span class="sidebar-text">Administración</span></a>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-20 bg-surface border-b border-default flex items-center justify-between px-6 shrink-0">
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle" class="p-2 rounded-full text-secondary hover:text-primary hover:bg-primary transition-colors" aria-label="Alternar sidebar">
                        <i data-lucide="menu"></i>
                    </button>
                    <div class="relative hidden md:block">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-secondary"></i>
                        <input type="text" placeholder="Buscar estudiante, grupo o materia..." class="bg-primary border border-default rounded-lg pl-10 pr-4 py-2 text-sm text-primary placeholder-secondary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2" aria-label="Búsqueda global">
                    </div>
                </div>
                <div class="flex items-center space-x-5">
                    <button id="theme-toggle" class="p-2 rounded-full text-secondary hover:text-primary hover:bg-primary transition-colors" aria-label="Alternar tema">
                        <i data-lucide="sun" class="block dark:hidden"></i>
                        <i data-lucide="moon" class="hidden dark:block"></i>
                    </button>
                    <button class="p-2 rounded-full text-secondary hover:text-primary hover:bg-primary transition-colors relative" aria-label="Notificaciones">
                        <i data-lucide="bell"></i>
                        <span class="absolute top-1.5 right-1.5 w-2.5 h-2.5 bg-accent-2 rounded-full border-2 border-surface"></span>
                    </button>
                    <div class="flex items-center space-x-3">
                        <img src="https://placehold.co/40x40/A78BFA/FFFFFF?text=AD" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-default">
                        <div class="hidden md:block">
                            <p class="font-semibold text-sm text-primary">Ana Díaz</p>
                            <p class="text-xs text-secondary">Administradora</p>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6 lg:p-10 bg-primary">
                <div id="page-dashboard" class="page-content space-y-8">
                    <h1 class="text-3xl font-bold text-primary">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="kpi-card bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-secondary">Asistencia Promedio</span>
                                <i data-lucide="users" class="text-accent-2"></i>
                            </div>
                            <p class="text-3xl font-bold text-primary">92.8%</p>
                            <p class="text-sm text-success flex items-center mt-1">
                                <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i>
                                +1.5% vs semana pasada
                            </p>
                        </div>
                        <div class="kpi-card bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-secondary">Tasa de Retardos</span>
                                <i data-lucide="clock-3" class="text-accent-1"></i>
                            </div>
                            <p class="text-3xl font-bold text-primary">3.1%</p>
                            <p class="text-sm text-success flex items-center mt-1">
                                <i data-lucide="trending-down" class="w-4 h-4 mr-1"></i>
                                -0.2% vs semana pasada
                            </p>
                        </div>
                        <div class="kpi-card bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-secondary">Alumnos en Riesgo</span>
                                <i data-lucide="alert-triangle" class="text-warning"></i>
                            </div>
                            <p class="text-3xl font-bold text-primary">14</p>
                            <p class="text-sm text-error flex items-center mt-1">
                                <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i>
                                +2 vs mes pasado
                            </p>
                        </div>
                        <div class="kpi-card bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-secondary">Calificaciones Capturadas</span>
                                <i data-lucide="check-circle" class="text-success"></i>
                            </div>
                            <p class="text-3xl font-bold text-primary">78%</p>
                            <p class="text-sm text-secondary flex items-center mt-1">Parcial 2</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <h3 class="text-lg font-semibold text-primary mb-4">Asistencia por Grupo (Última Semana)</h3>
                            <div class="h-80">
                                <canvas id="asistenciaChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <h3 class="text-lg font-semibold text-primary mb-4">Promedio de Calificaciones (Semanal)</h3>
                            <div class="h-80">
                                <canvas id="calificacionesChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <h3 class="text-lg font-semibold text-primary mb-4">Estatus de Evaluaciones (Parcial 2)</h3>
                            <div class="h-80 w-full flex justify-center">
                                <canvas id="estatusChart" class="max-w-xs"></canvas>
                            </div>
                        </div>
                        <div class="bg-surface rounded-2xl p-6 shadow-sm border border-default">
                            <h3 class="text-lg font-semibold text-primary mb-4">Heatmap de Faltas (Semanal por Grupo)</h3>
                            <table class="w-full border-collapse text-center">
                                <thead>
                                    <tr class="border-b border-default">
                                        <th class="py-2 text-sm font-medium text-secondary">Grupo</th>
                                        <th class="py-2 text-sm font-medium text-secondary">Lunes</th>
                                        <th class="py-2 text-sm font-medium text-secondary">Martes</th>
                                        <th class="py-2 text-sm font-medium text-secondary">Miércoles</th>
                                        <th class="py-2 text-sm font-medium text-secondary">Jueves</th>
                                        <th class="py-2 text-sm font-medium text-secondary">Viernes</th>
                                    </tr>
                                </thead>
                                <tbody id="heatmap-body" class="text-xs text-primary font-medium"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="page-asistencias" class="page-content hidden space-y-6">
                    <h1 class="text-3xl font-bold text-primary">Tomar Asistencia</h1>
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-[200px]">
                            <label for="select-grupo" class="block text-sm font-medium text-secondary mb-1">Grupo</label>
                            <select id="select-grupo" class="w-full bg-surface border border-default rounded-lg px-3 py-2 text-primary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2">
                                <option>Grupo 101-A (Matemáticas)</option>
                                <option>Grupo 102-B (Física)</option>
                                <option>Grupo 103-C (Historia)</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="select-fecha" class="block text-sm font-medium text-secondary mb-1">Fecha</label>
                            <input type="date" id="select-fecha" class="w-full bg-surface border border-default rounded-lg px-3 py-2 text-primary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2">
                        </div>
                        <button id="btn-load-list" class="self-end bg-accent-1 text-white px-4 py-2 rounded-lg font-medium hover:brightness-110 transition-all">Cargar Lista</button>
                    </div>

                    <div class="bg-surface rounded-2xl p-4 border border-default flex flex-wrap gap-4 justify-between items-center">
                        <p class="text-secondary text-sm"><span class="font-bold text-primary">Tip:</span> Usa el teclado para marcar rápido (P, F, R, J) o usa los botones.</p>
                        <div>
                            <button id="mark-all-present" class="text-sm font-medium text-accent-1 hover:text-accent-2">Marcar Todos como Presente</button>
                        </div>
                    </div>

                    <div class="bg-surface rounded-2xl shadow-sm border border-default overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[700px]">
                                <thead class="bg-primary border-b border-default">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">#</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Matrícula</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Nombre Completo</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-secondary uppercase tracking-wider">Estado (P, F, R, J)</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Comentarios</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-secondary uppercase tracking-wider">Acción</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-default text-primary">
                                    <tr class="hover:bg-primary transition-colors">
                                        <td class="py-3 px-4 text-sm text-secondary">1</td>
                                        <td class="py-3 px-4 text-sm font-medium">A001</td>
                                        <td class="py-3 px-4 text-sm">Aguilar, Juan Pérez</td>
                                        <td class="py-3 px-4">
                                            <div class="flex justify-center space-x-2 attendance-radio-group">
                                                <input type="radio" id="s1_p" name="student_1" value="P" checked><label for="s1_p">P</label>
                                                <input type="radio" id="s1_f" name="student_1" value="F"><label for="s1_f">F</label>
                                                <input type="radio" id="s1_r" name="student_1" value="R"><label for="s1_r">R</label>
                                                <input type="radio" id="s1_j" name="student_1" value="J"><label for="s1_j">J</label>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4"><input type="text" placeholder="Añadir nota..." class="w-full text-sm bg-transparent border-b border-default focus:outline-none focus:border-accent-1"></td>
                                        <td class="py-3 px-4"><button class="p-1 text-secondary hover:text-accent-2"><i data-lucide="paperclip" class="w-4 h-4"></i></button></td>
                                    </tr>
                                    <tr class="hover:bg-primary transition-colors">
                                        <td class="py-3 px-4 text-sm text-secondary">2</td>
                                        <td class="py-3 px-4 text-sm font-medium">A002</td>
                                        <td class="py-3 px-4 text-sm">García, Maria López</td>
                                        <td class="py-3 px-4">
                                            <div class="flex justify-center space-x-2 attendance-radio-group">
                                                <input type="radio" id="s2_p" name="student_2" value="P"><label for="s2_p">P</label>
                                                <input type="radio" id="s2_f" name="student_2" value="F" checked><label for="s2_f">F</label>
                                                <input type="radio" id="s2_r" name="student_2" value="R"><label for="s2_r">R</label>
                                                <input type="radio" id="s2_j" name="student_2" value="J"><label for="s2_j">J</label>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4"><input type="text" placeholder="Añadir nota..." class="w-full text-sm bg-transparent border-b border-default focus:outline-none focus:border-accent-1"></td>
                                        <td class="py-3 px-4"><button class="p-1 text-secondary hover:text-accent-2"><i data-lucide="paperclip" class="w-4 h-4"></i></button></td>
                                    </tr>
                                    <tr class="hover:bg-primary transition-colors">
                                        <td class="py-3 px-4 text-sm text-secondary">3</td>
                                        <td class="py-3 px-4 text-sm font-medium">A003</td>
                                        <td class="py-3 px-4 text-sm">Hernández, Luis Martínez</td>
                                        <td class="py-3 px-4">
                                            <div class="flex justify-center space-x-2 attendance-radio-group">
                                                <input type="radio" id="s3_p" name="student_3" value="P"><label for="s3_p">P</label>
                                                <input type="radio" id="s3_f" name="student_3" value="F"><label for="s3_f">F</label>
                                                <input type="radio" id="s3_r" name="student_3" value="R" checked><label for="s3_r">R</label>
                                                <input type="radio" id="s3_j" name="student_3" value="J"><label for="s3_j">J</label>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4"><input type="text" value="Llegó 10 min tarde" class="w-full text-sm bg-transparent border-b border-default focus:outline-none focus:border-accent-1"></td>
                                        <td class="py-3 px-4"><button class="p-1 text-secondary hover:text-accent-2"><i data-lucide="paperclip" class="w-4 h-4"></i></button></td>
                                    </tr>
                                    <tr class="hover:bg-primary transition-colors">
                                        <td class="py-3 px-4 text-sm text-secondary">4</td>
                                        <td class="py-3 px-4 text-sm font-medium">A004</td>
                                        <td class="py-3 px-4 text-sm">Morales, Ana Sofía</td>
                                        <td class="py-3 px-4">
                                            <div class="flex justify-center space-x-2 attendance-radio-group">
                                                <input type="radio" id="s4_p" name="student_4" value="P"><label for="s4_p">P</label>
                                                <input type="radio" id="s4_f" name="student_4" value="F"><label for="s4_f">F</label>
                                                <input type="radio" id="s4_r" name="student_4" value="R"><label for="s4_r">R</label>
                                                <input type="radio" id="s4_j" name="student_4" value="J" checked><label for="s4_j">J</label>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4"><input type="text" value="Cita médica (adjunto)" class="w-full text-sm bg-transparent border-b border-default focus:outline-none focus:border-accent-1"></td>
                                        <td class="py-3 px-4"><button class="p-1 text-accent-2 hover:text-accent-1"><i data-lucide="paperclip" class="w-4 h-4"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 bg-primary border-t border-default flex justify-end">
                            <button id="btn-save-attendance" class="bg-accent-1 text-white px-5 py-2 rounded-lg font-medium hover:brightness-110 transition-transform hover:scale-102">Guardar Asistencia</button>
                        </div>
                    </div>
                </div>

                <div id="page-calificaciones" class="page-content hidden space-y-6">
                    <h1 class="text-3xl font-bold text-primary">Capturar Calificaciones</h1>
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1 min-w-[200px]">
                            <label for="select-grupo-cal" class="block text-sm font-medium text-secondary mb-1">Grupo/Materia</label>
                            <select id="select-grupo-cal" class="w-full bg-surface border border-default rounded-lg px-3 py-2 text-primary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2">
                                <option>Grupo 101-A (Matemáticas)</option>
                                <option>Grupo 102-B (Física)</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="select-periodo-cal" class="block text-sm font-medium text-secondary mb-1">Periodo</label>
                            <select id="select-periodo-cal" class="w-full bg-surface border border-default rounded-lg px-3 py-2 text-primary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2">
                                <option>Parcial 2</option>
                                <option>Parcial 1</option>
                                <option>Final</option>
                            </select>
                        </div>
                        <button class="self-end bg-accent-1 text-white px-4 py-2 rounded-lg font-medium hover:brightness-110 transition-all">Cargar Rúbrica</button>
                    </div>

                    <div class="bg-surface rounded-2xl shadow-sm border border-default overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[800px] grades-table">
                                <thead class="bg-primary border-b border-default">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-secondary uppercase">Matrícula</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-secondary uppercase">Nombre</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-secondary uppercase">Tareas (20%)</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-secondary uppercase">Examen (50%)</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-secondary uppercase">Proyecto (30%)</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-secondary uppercase">Promedio</th>
                                        <th class="py-3 px-4 text-center text-xs font-semibold text-secondary uppercase">Estado</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-default text-primary">
                                    <tr class="grade-row hover:bg-primary transition-colors">
                                        <td class="py-3 px-4 text-sm font-medium">A001</td>
                                        <td class="py-3 px-4 text-sm">Aguilar, Juan Pérez</td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="95" data-weight="0.20" min="0" max="100"></td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="80" data-weight="0.50" min="0" max="100"></td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="100" data-weight="0.30" min="0" max="100"></td>
                                        <td class="py-3 px-4 text-center text-sm font-bold grade-avg">89.5</td>
                                        <td class="py-3 px-4 text-center text-sm"><span class="px-2 py-0.5 rounded-full bg-success/20 text-success text-xs font-medium">Aprobado</span></td>
                                    </tr>
                                    <tr class="grade-row hover:bg-primary transition-colors">
                                        <td class="py-3 px-4 text-sm font-medium">A002</td>
                                        <td class="py-3 px-4 text-sm">García, Maria López</td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="100" data-weight="0.20" min="0" max="100"></td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="75" data-weight="0.50" min="0" max="100"></td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="85" data-weight="0.30" min="0" max="100"></td>
                                        <td class="py-3 px-4 text-center text-sm font-bold grade-avg">83.0</td>
                                        <td class="py-3 px-4 text-center text-sm"><span class="px-2 py-0.5 rounded-full bg-success/20 text-success text-xs font-medium">Aprobado</span></td>
                                    </tr>
                                    <tr class="grade-row hover:bg-primary transition-colors">
                                        <td class="py-3 px-4 text-sm font-medium">A003</td>
                                        <td class="py-3 px-4 text-sm">Hernández, Luis Martínez</td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="50" data-weight="0.20" min="0" max="100"></td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="65" data-weight="0.50" min="0" max="100"></td>
                                        <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="" data-weight="0.30" min="0" max="100"></td>
                                        <td class="py-3 px-4 text-center text-sm font-bold grade-avg">42.5</td>
                                        <td class="py-3 px-4 text-center text-sm"><span class="px-2 py-0.5 rounded-full bg-warning/20 text-warning text-xs font-medium">En Riesgo</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 bg-primary border-t border-default flex justify-between items-center">
                            <button id="btn-publish-grades" class="bg-accent-2/20 text-accent-2 px-5 py-2 rounded-lg font-medium hover:bg-accent-2/30 transition-all text-sm">Publicar Calificaciones</button>
                            <button id="btn-save-grades" class="bg-accent-1 text-white px-5 py-2 rounded-lg font-medium hover:brightness-110 transition-transform hover:scale-102">Guardar Cambios</button>
                        </div>
                    </div>
                </div>

                <div id="page-importar" class="page-content hidden space-y-6">
                    <h1 class="text-3xl font-bold text-primary">Asistente de Importación</h1>
                    <div class="bg-surface rounded-2xl shadow-sm border border-default p-6 lg:p-10">
                        <div class="flex items-center mb-10">
                            <div id="step-1" class="step-item active"><span class="step-circle">1</span> 1. Cargar Archivo</div>
                            <div class="step-connector"></div>
                            <div id="step-2" class="step-item"><span class="step-circle">2</span> 2. Mapear Columnas</div>
                            <div class="step-connector"></div>
                            <div id="step-3" class="step-item"><span class="step-circle">3</span> 3. Validar Datos</div>
                            <div class="step-connector"></div>
                            <div id="step-4" class="step-item"><span class="step-circle">4</span> 4. Confirmar</div>
                        </div>
                        <div id="wizard-content">
                            <div id="content-step-1" class="wizard-step">
                                <h2 class="text-xl font-semibold text-primary mb-4">1. Cargar Archivo</h2>
                                <p class="text-secondary mb-6">Selecciona o arrastra el archivo (.xlsx, .csv, .ods) que deseas importar.</p>
                                <div class="border-2 border-dashed border-default rounded-2xl p-12 text-center cursor-pointer hover:border-accent-1 transition-colors" id="dropzone">
                                    <i data-lucide="upload-cloud" class="w-16 h-16 mx-auto text-accent-1"></i>
                                    <p class="mt-4 font-medium text-primary">Arrastra y suelta tu archivo aquí</p>
                                    <p class="text-secondary text-sm mt-1">o haz clic para seleccionar</p>
                                    <input type="file" class="hidden" id="file-upload">
                                </div>
                                <div class="text-right mt-8">
                                    <button id="btn-goto-step2" class="bg-accent-1 text-white px-6 py-2 rounded-lg font-medium hover:brightness-110 transition-transform hover:scale-102">Siguiente</button>
                                </div>
                            </div>
                            <div id="content-step-2" class="wizard-step hidden">
                                <h2 class="text-xl font-semibold text-primary mb-4">2. Mapear Columnas</h2>
                                <p class="text-secondary mb-6">Asigna las columnas de tu archivo a los campos del sistema. Hemos intentado adivinar por ti.</p>
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center p-4 bg-primary rounded-lg border border-default">
                                        <div class="font-medium text-primary">Campo del Sistema</div>
                                        <div class="font-medium text-primary">Columna de tu Archivo</div>
                                        <div class="font-medium text-primary">Vista Previa</div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center p-4 bg-transparent rounded-lg">
                                        <label class="font-semibold text-primary">Matrícula <span class="text-error">*</span></label>
                                        <select class="w-full bg-surface border border-default rounded-lg px-3 py-2 text-primary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2"><option value="matricula" selected>matricula</option><option value="nombre">nombre</option><option value="apellidos">apellidos</option></select>
                                        <div class="text-secondary text-sm truncate italic">"A001"</div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center p-4 bg-transparent rounded-lg">
                                        <label class="font-semibold text-primary">Nombre <span class="text-error">*</span></label>
                                        <select class="w-full bg-surface border border-default rounded-lg px-3 py-2 text-primary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2"><option value="matricula">matricula</option><option value="nombre" selected>nombre</option><option value="apellidos">apellidos</option></select>
                                        <div class="text-secondary text-sm truncate italic">"Juan"</div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center p-4 bg-transparent rounded-lg">
                                        <label class="font-semibold text-primary">Apellidos <span class="text-error">*</span></label>
                                        <select class="w-full bg-surface border border-default rounded-lg px-3 py-2 text-primary focus:outline-none focus:ring-2 focus:ring-accent-2/50 focus:border-accent-2"><option value="matricula">matricula</option><option value="nombre">nombre</option><option value="apellidos" selected>apellidos</option></select>
                                        <div class="text-secondary text-sm truncate italic">"Pérez"</div>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-8">
                                    <button id="btn-back-step1" class="bg-surface border border-default text-primary px-6 py-2 rounded-lg font-medium hover:bg-primary">Atrás</button>
                                    <button id="btn-goto-step3" class="bg-accent-1 text-white px-6 py-2 rounded-lg font-medium hover:brightness-110">Validar Datos</button>
                                </div>
                            </div>
                            <div id="content-step-3" class="wizard-step hidden">
                                <h2 class="text-xl font-semibold text-primary mb-4">3. Validar Datos</h2>
                                <p class="text-secondary mb-6">Revisa los datos antes de importar. Se encontraron algunos errores.</p>
                                <div class="flex gap-6 mb-4">
                                    <div class="bg-success/20 text-success p-4 rounded-lg flex-1"><p class="text-2xl font-bold">1,450</p><p class="font-medium">Filas Válidas</p></div>
                                    <div class="bg-error/20 text-error p-4 rounded-lg flex-1"><p class="text-2xl font-bold">3</p><p class="font-medium">Filas con Errores</p></div>
                                </div>
                                <p class="text-primary font-medium mb-2">Vista previa de errores:</p>
                                <div class="bg-surface rounded-lg border border-default overflow-hidden">
                                    <table class="w-full text-sm">
                                        <thead class="bg-primary">
                                            <tr>
                                                <th class="p-2 text-left text-secondary font-medium">Fila</th>
                                                <th class="p-2 text-left text-secondary font-medium">Matrícula</th>
                                                <th class="p-2 text-left text-secondary font-medium">Nombre</th>
                                                <th class="p-2 text-left text-secondary font-medium">Error</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-t border-default bg-error/10"><td class="p-2 text-primary">58</td><td class="p-2 text-primary">A001</td><td class="p-2 text-primary">Pedro Ramirez</td><td class="p-2 text-error font-medium">Matrícula duplicada</td></tr>
                                            <tr class="border-t border-default bg-error/10"><td class="p-2 text-primary">102</td><td class="p-2 text-primary">A999</td><td class="p-2 text-primary"></td><td class="p-2 text-error font-medium">Nombre vacío</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="flex justify-between mt-8">
                                    <button id="btn-back-step2" class="bg-surface border border-default text-primary px-6 py-2 rounded-lg font-medium hover:bg-primary">Atrás</button>
                                    <button id="btn-goto-step4" class="bg-accent-1 text-white px-6 py-2 rounded-lg font-medium hover:brightness-110">Confirmar Importación</button>
                                </div>
                            </div>
                            <div id="content-step-4" class="wizard-step hidden">
                                <div class="text-center max-w-md mx-auto">
                                    <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_iszf7s2p.json" background="transparent" speed="1" style="width: 200px; height: 200px; margin: 0 auto;" loop autoplay></lottie-player>
                                    <h2 class="text-2xl font-bold text-primary mt-4">¡Importación Exitosa!</h2>
                                    <p class="text-secondary mt-2 mb-6">Se importaron 1,450 registros correctamente y se omitieron 3 con errores.</p>
                                    <div class="flex gap-4 justify-center">
                                        <button class="bg-surface border border-default text-primary px-6 py-2 rounded-lg font-medium hover:bg-primary">Descargar Log de Errores</button>
                                        <button id="btn-finish-import" class="bg-accent-1 text-white px-6 py-2 rounded-lg font-medium hover:brightness-110">Ir a Estudiantes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-estudiantes" class="page-content hidden"><h1 class="text-3xl font-bold text-primary">Estudiantes</h1><div class="mt-6 bg-surface rounded-2xl p-6 border border-default"><p class="text-secondary">Aquí iría el listado CRUD de estudiantes con búsqueda avanzada.</p></div></div>
                <div id="page-grupos" class="page-content hidden"><h1 class="text-3xl font-bold text-primary">Grupos y Materias</h1><div class="mt-6 bg-surface rounded-2xl p-6 border border-default"><p class="text-secondary">Aquí iría el listado de grupos y materias.</p></div></div>
                <div id="page-reportes" class="page-content hidden"><h1 class="text-3xl font-bold text-primary">Reportes</h1><div class="mt-6 bg-surface rounded-2xl p-6 border border-default"><p class="text-secondary">Aquí iría el generador de reportes con filtros.</p></div></div>
                <div id="page-admin" class="page-content hidden"><h1 class="text-3xl font-bold text-primary">Administración</h1><div class="mt-6 bg-surface rounded-2xl p-6 border border-default"><p class="text-secondary">Aquí iría la administración de usuarios, roles y catálogos.</p></div></div>
            </main>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide && lucide.createIcons) lucide.createIcons();

        const themeToggle = document.getElementById('theme-toggle');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page-content');

        // Persistir fecha por defecto: hoy
        const dateInput = document.getElementById('select-fecha');
        if (dateInput && !dateInput.value) {
          const tzOffset = new Date().getTimezoneOffset();
          const local = new Date(Date.now() - tzOffset * 60000).toISOString().slice(0,10);
          dateInput.value = local;
        }

        // Theme Toggler (Dark/Light) con persistencia
        themeToggle.addEventListener('click', () => {
          const root = document.documentElement;
          root.classList.toggle('dark');
          const nowDark = root.classList.contains('dark');
          try { localStorage.setItem('ui-theme', nowDark ? 'dark' : 'light'); } catch(e){}
          // Reinit charts con tema
          reinitCharts();
        }, { passive: true });

        // Sidebar Toggle con persistencia
        const applySidebarState = (collapsed) => {
          if (collapsed) {
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-20');
            document.querySelectorAll('.sidebar-text').forEach(s => s.classList.add('hidden'));
          } else {
            sidebar.classList.add('w-64');
            sidebar.classList.remove('w-20');
            document.querySelectorAll('.sidebar-text').forEach(s => s.classList.remove('hidden'));
          }
        };
        const savedSidebar = localStorage.getItem('sidebar-collapsed');
        applySidebarState(savedSidebar === '1');
        sidebarToggle.addEventListener('click', () => {
          const collapsed = sidebar.classList.contains('w-64');
          applySidebarState(collapsed);
          try { localStorage.setItem('sidebar-collapsed', collapsed ? '1' : '0'); } catch(e){}
        }, { passive: true });

        // Navegación simple SPA
        function setActiveLink(targetLink){
          navLinks.forEach(l => l.classList.remove('active','bg-primary','text-accent-1'));
          targetLink.classList.add('active','bg-primary','text-accent-1');
        }
        navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = link.getAttribute('data-page');
            pages.forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) targetPage.classList.remove('hidden');
            setActiveLink(link);
            if (pageId === 'dashboard') reinitCharts();
            if (pageId === 'estudiantes') renderStudentsPage();
            if (pageId === 'grupos') renderGroupsPage();
            if (pageId === 'asistencias') initAttendancePage();
            if (pageId === 'calificaciones') initGradesPage();
            if (pageId === 'importar') initImportWizard();
            if (pageId === 'reportes') renderReportsPage();
          });
        });
        const defaultLink = document.querySelector('.nav-link[data-page="dashboard"]');
        if (defaultLink) setActiveLink(defaultLink);

        // Wizard importación: navegación
        const wizardSteps = document.querySelectorAll('.step-item');
        const wizardPages = document.querySelectorAll('.wizard-step');
        const goToStep = (n) => {
          wizardPages.forEach(p => p.classList.add('hidden'));
          const c = document.getElementById(`content-step-${n}`);
          if (c) c.classList.remove('hidden');
          wizardSteps.forEach((s, i) => {
            s.classList.remove('active','completed');
            if (i + 1 < n) s.classList.add('completed');
            else if (i + 1 === n) s.classList.add('active');
          });
        };
        const byId = (id) => document.getElementById(id);
        byId('btn-goto-step2')?.addEventListener('click', () => goToStep(2));
        byId('btn-goto-step3')?.addEventListener('click', () => goToStep(3));
        byId('btn-goto-step4')?.addEventListener('click', () => goToStep(4));
        byId('btn-back-step1')?.addEventListener('click', () => goToStep(1));
        byId('btn-back-step2')?.addEventListener('click', () => goToStep(2));
        byId('btn-finish-import')?.addEventListener('click', () => {
          document.querySelector('.nav-link[data-page="estudiantes"]').click();
          goToStep(1);
        });

        // Dropzone básico accesible
        const drop = byId('dropzone');
        const fileInput = byId('file-upload');
        if (drop && fileInput) {
          drop.addEventListener('click', () => fileInput.click());
          ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.add('ring-2','ring-accent-1');}));
          ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();drop.classList.remove('ring-2','ring-accent-1');}));
          drop.addEventListener('drop', (e)=>{ if(e.dataTransfer?.files?.length){ fileInput.files = e.dataTransfer.files; }});
        }

        // Calificaciones: cálculo automático y validación
        const gradesTable = document.querySelector('.grades-table');
        if (gradesTable) {
          gradesTable.addEventListener('input', (e) => {
            const t = e.target;
            if (!(t instanceof HTMLInputElement) || !t.classList.contains('grade-input')) return;
            const row = t.closest('.grade-row');
            if (!row) return;
            const inputs = row.querySelectorAll('.grade-input');
            const avgCell = row.querySelector('.grade-avg');
            const statusCell = row.querySelector('td:nth-child(7) span');
            let totalAvg = 0, allFilled = true;
            inputs.forEach(input => {
              const value = parseFloat(input.value);
              const weight = parseFloat(input.dataset.weight || '0');
              if (input.value === '') { allFilled = false; }
              if (isNaN(value) || value < 0 || value > 100) {
                input.classList.add('border-error','ring-2','ring-error/50');
              } else {
                input.classList.remove('border-error','ring-2','ring-error/50');
                totalAvg += value * weight;
              }
            });
            if (avgCell) avgCell.textContent = allFilled ? totalAvg.toFixed(1) : totalAvg.toFixed(1) + '...';
            if (statusCell) {
              if (totalAvg < 70) {
                statusCell.textContent = 'En Riesgo';
                statusCell.className = 'px-2 py-0.5 rounded-full bg-warning/20 text-warning text-xs font-medium';
              } else {
                statusCell.textContent = 'Aprobado';
                statusCell.className = 'px-2 py-0.5 rounded-full bg-success/20 text-success text-xs font-medium';
              }
            }
          });
        }

        // Atajos de teclado para asistencia: P/F/R/J en fila enfocada
        document.addEventListener('keydown', (e) => {
          if (!['p','f','r','j','P','F','R','J'].includes(e.key)) return;
          const letter = e.key.toUpperCase();
          const focusedRow = document.activeElement?.closest?.('tr');
          if (!focusedRow) return;
          const input = focusedRow.querySelector(`.attendance-radio-group input[value="${letter}"]`);
          if (input) { input.checked = true; e.preventDefault(); }
        });
        // Botón marcar todos presente
        document.getElementById('mark-all-present')?.addEventListener('click', ()=>{
          document.querySelectorAll('.attendance-radio-group').forEach(g=>{
            const p = g.querySelector('input[value="P"]'); if (p) p.checked = true;
          });
        });

        // Gráficas
        let charts = { asistencia: null, calificaciones: null, estatus: null };
        function initCharts() {
          const isDark = document.documentElement.classList.contains('dark');
          const textColor = isDark ? 'rgba(230, 234, 242, 0.8)' : 'rgba(107, 114, 128, 1)';
          const gridColor = isDark ? 'rgba(55, 65, 81, 0.3)' : 'rgba(229, 231, 235, 0.5)';
          const accent1 = isDark ? '#4FD1C5' : '#3EBBAF';
          const accent2 = isDark ? '#A78BFA' : '#9F80F8';
          const warning = isDark ? '#FBBF24' : '#F59E0B';
          const error = isDark ? '#F87171' : '#EF4444';
          const success = isDark ? '#34D399' : '#10B981';
          if (window.Chart) {
            Chart.defaults.color = textColor;
            Chart.defaults.font.family = 'Inter';
          }
          const ctxAs = document.getElementById('asistenciaChart');
          if (ctxAs && !charts.asistencia) {
            charts.asistencia = new Chart(ctxAs, { type: 'bar', data: { labels: ['101-A','102-B','103-C','201-A','202-B'], datasets: [ { label: 'Presente', data: [88,92,95,85,90], backgroundColor: success }, { label: 'Falta', data: [5,3,2,10,4], backgroundColor: error }, { label: 'Retardo', data: [7,5,3,5,6], backgroundColor: warning } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, grid: { color: gridColor }, ticks: { callback: v => v + '%' } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rectRounded' } } } } });
          }
          const ctxCal = document.getElementById('calificacionesChart');
          if (ctxCal && !charts.calificaciones) {
            charts.calificaciones = new Chart(ctxCal, { type: 'line', data: { labels: ['Sem 1','Sem 2','Sem 3','Sem 4','Sem 5','Sem 6'], datasets: [ { label: 'Matemáticas', data: [78,80,82,85,83,88], borderColor: accent1, tension: 0.3, fill: false, borderWidth: 2.5 }, { label: 'Física', data: [85,82,88,86,90,91], borderColor: accent2, tension: 0.3, fill: false, borderWidth: 2.5 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: gridColor }, min: 60, max: 100 }, x: { grid: { display: false } } }, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } } } });
          }
          const ctxEs = document.getElementById('estatusChart');
          if (ctxEs && !charts.estatus) {
            charts.estatus = new Chart(ctxEs, { type: 'doughnut', data: { labels: ['Completo','En Proceso','Pendiente'], datasets: [{ data: [78,12,10], backgroundColor: [success, accent2, warning], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rectRounded' } } } } });
          }
        }
        function updateChartPalette() {
          // Destruir y recrear para aplicar paleta; Chart.js 4 no soporta cambiar todos colores de datasets fácilmente
          Object.keys(charts).forEach(k => { if (charts[k]) { charts[k].destroy(); charts[k] = null; } });
          initCharts();
        }
        function buildHeatmap() {
          const isDark = document.documentElement.classList.contains('dark');
          const heatmapBody = document.getElementById('heatmap-body');
          if (!heatmapBody) return;
          heatmapBody.innerHTML = '';
          const data = [ { grupo: '101-A', faltas: [1,2,1,10,3] }, { grupo: '102-B', faltas: [3,0,5,2,1] }, { grupo: '103-C', faltas: [0,1,0,0,2] }, { grupo: '201-A', faltas: [8,5,12,4,7] } ];
          const hexToRgba = (hex, alpha) => { const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; };
          const palette = { error: '#EF4444', warning: '#F59E0B', accent1: '#3EBBAF', text: isDark ? '#E6EAF2' : '#111726' };
          data.forEach(row => {
            const tr = document.createElement('tr'); tr.className = 'border-b border-default';
            let tds = `<td class="py-2 px-3 font-semibold text-primary text-sm">${row.grupo}</td>`;
            row.faltas.forEach(val => {
              const opacity = Math.min(val / 20, 1);
              const color = val > 8 ? palette.error : (val > 3 ? palette.warning : palette.accent1);
              tds += `<td class="p-1"><div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color:${hexToRgba(color, opacity)}; color:${opacity > 0.6 ? 'white' : palette.text};">${val}%</div></td>`;
            });
            tr.innerHTML = tds; heatmapBody.appendChild(tr);
          });
        }
        function reinitCharts(){ updateChartPalette(); buildHeatmap(); }

        // Inicializar
        initCharts();
        buildHeatmap();

        // ======= DATASTORE (localStorage) =======
        const STORE_KEY = 'escolar_io_v1';
        const DataStore = {
          state: { students: [], groups: [], attendance: [], grades: [] },
          load() {
            try { this.state = JSON.parse(localStorage.getItem(STORE_KEY)) || this.state; } catch(e){}
          },
          save() {
            try { localStorage.setItem(STORE_KEY, JSON.stringify(this.state)); } catch(e){}
          },
          seedIfEmpty() {
            if (this.state.students.length === 0 && this.state.groups.length === 0) {
              this.state.groups = [
                { id: 'g1', nombre: '101-A', materia: 'Matemáticas' },
                { id: 'g2', nombre: '102-B', materia: 'Física' },
                { id: 'g3', nombre: '103-C', materia: 'Historia' }
              ];
              this.state.students = [
                { id: 's1', matricula: 'A001', nombre: 'Juan', apellidos: 'Aguilar Pérez', grupos: ['g1'] },
                { id: 's2', matricula: 'A002', nombre: 'Maria', apellidos: 'García López', grupos: ['g1','g2'] },
                { id: 's3', matricula: 'A003', nombre: 'Luis', apellidos: 'Hernández Martínez', grupos: ['g1'] },
                { id: 's4', matricula: 'A004', nombre: 'Ana Sofía', apellidos: 'Morales', grupos: ['g2'] }
              ];
              this.save();
            }
          }
        };
        DataStore.load();
        DataStore.seedIfEmpty();

        // ======= HELPERS =======
        const uid = (p='id') => p + Math.random().toString(36).slice(2,8);
        const fmtName = s => `${s.apellidos}, ${s.nombre}`;
        const byIdSel = id => document.getElementById(id);
        const qs = (sel, root=document) => root.querySelector(sel);
        const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // ======= ESTUDIANTES (CRUD) =======
        function renderStudentsPage(){
          const container = byIdSel('page-estudiantes');
          if (!container) return;
          const list = DataStore.state.students;
          const groups = DataStore.state.groups;
          container.innerHTML = `
            <h1 class="text-3xl font-bold text-primary">Estudiantes</h1>
            <div class="mt-4 flex flex-wrap gap-3 items-center">
              <input id="stu-search" type="text" placeholder="Buscar por matrícula o nombre" class="bg-surface border border-default rounded-lg px-3 py-2 text-sm w-72" />
              <button id="btn-add-stu" class="bg-accent-1 text-white px-4 py-2 rounded-lg text-sm">Agregar Estudiante</button>
              <button id="btn-export-stu" class="bg-accent-2/20 text-accent-2 px-4 py-2 rounded-lg text-sm">Exportar CSV</button>
            </div>
            <div class="mt-4 bg-surface rounded-2xl p-4 border border-default">
              <div id="stu-form" class="hidden grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                <input id="f-mat" class="bg-primary border border-default rounded-lg px-3 py-2" placeholder="Matrícula" />
                <input id="f-nom" class="bg-primary border border-default rounded-lg px-3 py-2" placeholder="Nombre" />
                <input id="f-ape" class="bg-primary border border-default rounded-lg px-3 py-2" placeholder="Apellidos" />
                <select id="f-grp" multiple class="bg-primary border border-default rounded-lg px-3 py-2">
                  ${groups.map(g=>`<option value="${g.id}">${g.nombre} (${g.materia})</option>`).join('')}
                </select>
                <div class="md:col-span-4 flex gap-2">
                  <button id="f-save" class="bg-accent-1 text-white px-4 py-2 rounded-lg text-sm">Guardar</button>
                  <button id="f-cancel" class="bg-surface border border-default px-4 py-2 rounded-lg text-sm">Cancelar</button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full min-w-[700px]">
                  <thead class="bg-primary border-b border-default">
                    <tr>
                      <th class="p-2 text-left text-secondary text-xs uppercase">Matrícula</th>
                      <th class="p-2 text-left text-secondary text-xs uppercase">Nombre</th>
                      <th class="p-2 text-left text-secondary text-xs uppercase">Grupos</th>
                      <th class="p-2 text-left text-secondary text-xs uppercase">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="stu-tbody" class="divide-y divide-default"></tbody>
                </table>
              </div>
            </div>`;

          const renderRows = (term='') => {
            const body = byIdSel('stu-tbody');
            const termLc = term.trim().toLowerCase();
            const filtered = list.filter(s => !termLc || s.matricula.toLowerCase().includes(termLc) || fmtName(s).toLowerCase().includes(termLc));
            body.innerHTML = filtered.map(s => {
              const gs = s.grupos.map(id => groups.find(g=>g.id===id)?.nombre || id).join(', ');
              return `<tr>
                <td class="p-2 text-sm font-medium">${s.matricula}</td>
                <td class="p-2 text-sm">${fmtName(s)}</td>
                <td class="p-2 text-sm">${gs}</td>
                <td class="p-2 text-sm">
                  <button data-edit="${s.id}" class="text-accent-2 mr-2">Editar</button>
                  <button data-del="${s.id}" class="text-error">Eliminar</button>
                </td>
              </tr>`;
            }).join('');
          };
          renderRows();

          byIdSel('stu-search').addEventListener('input', e => renderRows(e.target.value));
          const form = byIdSel('stu-form');
          byIdSel('btn-add-stu').addEventListener('click', ()=>{ form.dataset.editing=''; form.classList.remove('hidden'); byIdSel('f-mat').value=''; byIdSel('f-nom').value=''; byIdSel('f-ape').value=''; qsa('#f-grp option').forEach(o=>o.selected=false); });
          byIdSel('f-cancel').addEventListener('click', ()=> form.classList.add('hidden'));
          byIdSel('f-save').addEventListener('click', ()=>{
            const matricula = byIdSel('f-mat').value.trim();
            const nombre = byIdSel('f-nom').value.trim();
            const apellidos = byIdSel('f-ape').value.trim();
            const gruposSel = qsa('#f-grp option:checked').map(o=>o.value);
            if (!matricula || !nombre || !apellidos) return alert('Completa matrícula, nombre y apellidos');
            const editingId = form.dataset.editing;
            const dupe = DataStore.state.students.find(s=>s.matricula===matricula && s.id!==editingId);
            if (dupe) return alert('Matrícula duplicada');
            if (editingId) {
              const s = DataStore.state.students.find(s=>s.id===editingId); if (!s) return;
              Object.assign(s, { matricula, nombre, apellidos, grupos: gruposSel });
            } else {
              DataStore.state.students.push({ id: uid('s'), matricula, nombre, apellidos, grupos: gruposSel });
            }
            DataStore.save(); form.classList.add('hidden'); renderRows(byIdSel('stu-search').value);
          });
          byIdSel('stu-tbody').addEventListener('click', (e)=>{
            const t = e.target;
            if (t.dataset.edit){
              const s = DataStore.state.students.find(x=>x.id===t.dataset.edit); if (!s) return;
              form.dataset.editing = s.id; form.classList.remove('hidden');
              byIdSel('f-mat').value = s.matricula; byIdSel('f-nom').value = s.nombre; byIdSel('f-ape').value = s.apellidos;
              qsa('#f-grp option').forEach(o=>o.selected = s.grupos.includes(o.value));
            }
            if (t.dataset.del){
              if (confirm('¿Eliminar estudiante?')) {
                DataStore.state.students = DataStore.state.students.filter(x=>x.id!==t.dataset.del);
                // limpiar referencias en grupos/asistencia/calificaciones no es crítico en demo
                DataStore.save(); renderRows(byIdSel('stu-search').value);
              }
            }
          });
          byIdSel('btn-export-stu').addEventListener('click', ()=>{
            const rows = [['matricula','nombre','apellidos','grupos']].concat(DataStore.state.students.map(s=>[s.matricula,s.nombre,s.apellidos,(s.grupos||[]).join('|')]));
            const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'estudiantes');
            XLSX.writeFile(wb, 'estudiantes.csv');
          });
        }

        // ======= GRUPOS (CRUD) =======
        function renderGroupsPage(){
          const container = byIdSel('page-grupos'); if (!container) return;
          const groups = DataStore.state.groups;
          container.innerHTML = `
            <h1 class="text-3xl font-bold text-primary">Grupos y Materias</h1>
            <div class="mt-4 flex gap-3 items-center">
              <input id="grp-nombre" placeholder="Nombre del grupo (p.ej. 101-A)" class="bg-surface border border-default rounded-lg px-3 py-2" />
              <input id="grp-materia" placeholder="Materia" class="bg-surface border border-default rounded-lg px-3 py-2" />
              <button id="grp-add" class="bg-accent-1 text-white px-4 py-2 rounded-lg text-sm">Agregar</button>
            </div>
            <div class="mt-4 bg-surface rounded-2xl p-4 border border-default">
              <table class="w-full">
                <thead class="bg-primary border-b border-default"><tr>
                  <th class="p-2 text-left text-secondary text-xs uppercase">Grupo</th>
                  <th class="p-2 text-left text-secondary text-xs uppercase">Materia</th>
                  <th class="p-2 text-left text-secondary text-xs uppercase">Alumnos</th>
                  <th class="p-2 text-left text-secondary text-xs uppercase">Acciones</th>
                </tr></thead>
                <tbody id="grp-tbody" class="divide-y divide-default"></tbody>
              </table>
            </div>`;
          const renderRows = () => {
            byIdSel('grp-tbody').innerHTML = groups.map(g=>{
              const count = DataStore.state.students.filter(s=>s.grupos?.includes(g.id)).length;
              return `<tr>
                <td class="p-2 text-sm font-medium">${g.nombre}</td>
                <td class="p-2 text-sm">${g.materia}</td>
                <td class="p-2 text-sm">${count}</td>
                <td class="p-2 text-sm">
                  <button data-assign="${g.id}" class="text-accent-2 mr-2">Asignar Alumnos</button>
                  <button data-delg="${g.id}" class="text-error">Eliminar</button>
                </td>
              </tr>`;
            }).join('');
          };
          renderRows();
          byIdSel('grp-add').addEventListener('click', ()=>{
            const nombre = byIdSel('grp-nombre').value.trim();
            const materia = byIdSel('grp-materia').value.trim();
            if (!nombre || !materia) return alert('Completa nombre y materia');
            DataStore.state.groups.push({ id: uid('g'), nombre, materia }); DataStore.save(); renderRows();
            byIdSel('grp-nombre').value=''; byIdSel('grp-materia').value='';
          });
          byIdSel('grp-tbody').addEventListener('click', (e)=>{
            const t = e.target;
            if (t.dataset.delg){
              if (confirm('¿Eliminar grupo?')){
                DataStore.state.groups = DataStore.state.groups.filter(g=>g.id!==t.dataset.delg);
                DataStore.state.students.forEach(s=> s.grupos = (s.grupos||[]).filter(id=>id!==t.dataset.delg));
                DataStore.save(); renderRows();
              }
            }
            if (t.dataset.assign){
              const g = DataStore.state.groups.find(x=>x.id===t.dataset.assign); if (!g) return;
              const current = new Set(DataStore.state.students.filter(s=>s.grupos?.includes(g.id)).map(s=>s.id));
              const list = DataStore.state.students.map(s=>{
                const checked = current.has(s.id) ? 'checked' : '';
                return `<label class="flex items-center gap-2"><input type="checkbox" value="${s.id}" ${checked}/> <span>${s.matricula} - ${fmtName(s)}</span></label>`;
              }).join('');
              const html = `<div class="p-4">${list}</div>`;
              const w = window.open('', '', 'width=520,height=600');
              if (w) {
                w.document.write(`<html><head><title>Asignar alumnos a ${g.nombre}</title></head><body>${html}<div class="p-4"><button id="ok">Guardar</button></div><script>document.getElementById('ok').onclick=function(){window.opener.postMessage({type:'assign',gid:'${g.id}',ids:Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value)},'*');window.close();};<\/script></body></html>`);
                w.document.close();
              }
            }
          });
          window.addEventListener('message', (ev)=>{
            if (ev.data?.type==='assign'){
              const { gid, ids } = ev.data; const set = new Set(ids);
              DataStore.state.students.forEach(s=>{
                const has = set.has(s.id);
                const arr = new Set(s.grupos||[]);
                if (has) arr.add(gid); else arr.delete(gid);
                s.grupos = Array.from(arr);
              });
              DataStore.save(); renderRows();
            }
          });
        }

        // ======= ASISTENCIAS =======
        function populateGroupSelect(selId){
          const sel = byIdSel(selId); if (!sel) return; sel.innerHTML = '';
          DataStore.state.groups.forEach(g=>{
            const opt = document.createElement('option'); opt.value = g.id; opt.textContent = `${g.nombre} (${g.materia})`; sel.appendChild(opt);
          });
        }
        function initAttendancePage(){
          populateGroupSelect('select-grupo');
          const groupSel = byIdSel('select-grupo');
          const tableBody = qs('#page-asistencias tbody');
          const loadBtn = byIdSel('btn-load-list');
          const saveBtn = byIdSel('btn-save-attendance');
          const dateInput = byIdSel('select-fecha');
          const loadList = () => {
            const gid = groupSel.value || DataStore.state.groups[0]?.id; if (!gid) return;
            const date = dateInput.value;
            const stu = DataStore.state.students.filter(s=>s.grupos?.includes(gid));
            const existing = DataStore.state.attendance.find(a=>a.groupId===gid && a.date===date);
            tableBody.innerHTML = stu.map((s,i)=>{
              const rec = existing?.records.find(r=>r.studentId===s.id);
              const val = rec?.estado || 'P';
              const note = rec?.comentario || '';
              return `<tr class="hover:bg-primary transition-colors" data-sid="${s.id}">
                <td class="py-3 px-4 text-sm text-secondary">${i+1}</td>
                <td class="py-3 px-4 text-sm font-medium">${s.matricula}</td>
                <td class="py-3 px-4 text-sm">${fmtName(s)}</td>
                <td class="py-3 px-4"><div class="flex justify-center space-x-2 attendance-radio-group">
                  <input type="radio" id="${s.id}_p" name="st_${s.id}" value="P" ${val==='P'?'checked':''}><label for="${s.id}_p">P</label>
                  <input type="radio" id="${s.id}_f" name="st_${s.id}" value="F" ${val==='F'?'checked':''}><label for="${s.id}_f">F</label>
                  <input type="radio" id="${s.id}_r" name="st_${s.id}" value="R" ${val==='R'?'checked':''}><label for="${s.id}_r">R</label>
                  <input type="radio" id="${s.id}_j" name="st_${s.id}" value="J" ${val==='J'?'checked':''}><label for="${s.id}_j">J</label>
                </div></td>
                <td class="py-3 px-4"><input type="text" class="w-full text-sm bg-transparent border-b border-default focus:outline-none focus:border-accent-1" value="${note}"></td>
                <td class="py-3 px-4"><button class="p-1 text-secondary hover:text-accent-2"><i data-lucide="paperclip" class="w-4 h-4"></i></button></td>
              </tr>`;
            }).join('');
            if (window.lucide && lucide.createIcons) lucide.createIcons();
          };
          if (loadBtn) loadBtn.onclick = loadList; loadList();
          if (saveBtn) saveBtn.onclick = () => {
            const gid = groupSel.value; const date = dateInput.value;
            const records = qsa('#page-asistencias tbody tr').map(tr=>{
              const sid = tr.getAttribute('data-sid');
              const estado = qs('input[type=radio]:checked', tr)?.value || 'P';
              const comentario = qs('input[type=text]', tr)?.value || '';
              return { studentId: sid, estado, comentario };
            });
            const idx = DataStore.state.attendance.findIndex(a=>a.groupId===gid && a.date===date);
            if (idx>=0) DataStore.state.attendance[idx] = { groupId: gid, date, records };
            else DataStore.state.attendance.push({ groupId: gid, date, records });
            DataStore.save(); alert('Asistencia guardada');
          };
        }

        // ======= CALIFICACIONES =======
        function populateSelectsForGrades(){
          populateGroupSelect('select-grupo-cal');
        }
        function initGradesPage(){
          populateSelectsForGrades();
          const groupSel = byIdSel('select-grupo-cal');
          const periodSel = byIdSel('select-periodo-cal');
          const table = qs('#page-calificaciones .grades-table tbody');
          const saveBtn = byIdSel('btn-save-grades');
          const publishBtn = byIdSel('btn-publish-grades');
          const load = () => {
            const gid = groupSel.value || DataStore.state.groups[0]?.id; const per = periodSel.value || 'Parcial 1';
            const stu = DataStore.state.students.filter(s=>s.grupos?.includes(gid));
            const grade = DataStore.state.grades.find(g=>g.groupId===gid && g.periodo===per);
            table.innerHTML = stu.map(s=>{
              const rec = grade?.records.find(r=>r.studentId===s.id) || {};
              const t = rec.tareas ?? '';
              const e = rec.examen ?? '';
              const p = rec.proyecto ?? '';
              const avg = isFinite(rec.promedio) ? rec.promedio.toFixed(1) : '';
              const status = rec.estado || (isFinite(rec.promedio) ? (rec.promedio<70?'En Riesgo':'Aprobado') : '');
              const badge = status==='En Riesgo' ? 'bg-warning/20 text-warning' : 'bg-success/20 text-success';
              return `<tr class="grade-row hover:bg-primary transition-colors" data-sid="${s.id}">
                <td class="py-3 px-4 text-sm font-medium">${s.matricula}</td>
                <td class="py-3 px-4 text-sm">${fmtName(s)}</td>
                <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="${t}" data-weight="0.20" min="0" max="100"></td>
                <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="${e}" data-weight="0.50" min="0" max="100"></td>
                <td class="p-2"><input type="number" class="grade-input w-20 text-center bg-primary border border-default rounded-lg p-1" value="${p}" data-weight="0.30" min="0" max="100"></td>
                <td class="py-3 px-4 text-center text-sm font-bold grade-avg">${avg}</td>
                <td class="py-3 px-4 text-center text-sm"><span class="px-2 py-0.5 rounded-full ${badge} text-xs font-medium">${status}</span></td>
              </tr>`;
            }).join('');
          };
          load();
          groupSel.onchange = load; periodSel.onchange = load;
          if (saveBtn) saveBtn.onclick = () => {
            const gid = groupSel.value; const per = periodSel.value;
            const records = qsa('#page-calificaciones tbody tr').map(tr=>{
              const sid = tr.getAttribute('data-sid');
              const inputs = qsa('.grade-input', tr);
              const tareas = parseFloat(inputs[0].value)||0, examen=parseFloat(inputs[1].value)||0, proyecto=parseFloat(inputs[2].value)||0;
              const promedio = +(tareas*0.2 + examen*0.5 + proyecto*0.3).toFixed(1);
              const estado = promedio<70 ? 'En Riesgo' : 'Aprobado';
              return { studentId: sid, tareas, examen, proyecto, promedio, estado };
            });
            const idx = DataStore.state.grades.findIndex(g=>g.groupId===gid && g.periodo===per);
            if (idx>=0) DataStore.state.grades[idx] = { groupId: gid, periodo: per, records };
            else DataStore.state.grades.push({ groupId: gid, periodo: per, records });
            DataStore.save(); alert('Calificaciones guardadas');
          };
          if (publishBtn) publishBtn.onclick = () => { alert('Calificaciones publicadas (simulado)'); };
        }

        // ======= IMPORTAR DATOS =======
        function initImportWizard(){
          // Ya está la UI; conectamos eventos de archivo y mapeo
          const fileInput = byIdSel('file-upload'); if (!fileInput) return;
          let parsed = []; let headers = [];
          const toArray = (ws) => XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
          const guessMap = () => {
            // heurística simple
            const h = headers.map(x=>x.toLowerCase());
            return {
              matricula: headers[h.indexOf('matricula')] || headers[h.indexOf('id')] || headers[0],
              nombre: headers[h.indexOf('nombre')] || headers[h.indexOf('nombres')] || headers[1],
              apellidos: headers[h.indexOf('apellidos')] || headers[h.indexOf('apellido')] || headers[2]
            };
          };
          const renderStep2 = () => {
            // Rellenar selects existentes en el DOM
            const selects = qsa('#content-step-2 select');
            selects.forEach((sel, i)=>{
              sel.innerHTML = headers.map(h=>`<option value="${h}">${h}</option>`).join('');
            });
            const g = guessMap();
            selects[0].value = g.matricula; selects[1].value = g.nombre; selects[2].value = g.apellidos;
          };
          const parseFile = async (file) => {
            const buf = await file.arrayBuffer();
            const wb = XLSX.read(buf, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const aoa = toArray(ws);
            headers = (aoa.shift()||[]).map(h => String(h||'').trim());
            parsed = aoa.filter(r => r.some(c=>String(c).trim()!==''));
            goToStep(2); renderStep2();
          };
          fileInput.onchange = (e)=>{ const f = e.target.files?.[0]; if (f) parseFile(f); };
          const drop = byIdSel('dropzone');
          if (drop) drop.ondrop = (e)=>{ e.preventDefault(); const f = e.dataTransfer?.files?.[0]; if (f) parseFile(f); };

          byIdSel('btn-goto-step3')?.addEventListener('click', ()=>{
            // Validar
            const sel = qsa('#content-step-2 select');
            const map = { matricula: sel[0].value, nombre: sel[1].value, apellidos: sel[2].value };
            const idx = k => headers.indexOf(map[k]);
            const rows = parsed.map(r=>({ matricula: String(r[idx('matricula')]||'').trim(), nombre: String(r[idx('nombre')]||'').trim(), apellidos: String(r[idx('apellidos')]||'').trim() }));
            const errores = [];
            const seen = new Set(DataStore.state.students.map(s=>s.matricula));
            rows.forEach((r,i)=>{
              if (!r.matricula) errores.push({ i, error: 'Matrícula vacía' });
              if (!r.nombre) errores.push({ i, error: 'Nombre vacío' });
              if (!r.apellidos) errores.push({ i, error: 'Apellidos vacíos' });
              if (seen.has(r.matricula)) errores.push({ i, error: 'Matrícula duplicada' });
              seen.add(r.matricula);
            });
            // Pintar conteo rápido
            qs('#content-step-3 .bg-success/20 .text-2xl').textContent = String(rows.length - errores.length);
            qs('#content-step-3 .bg-error/20 .text-2xl').textContent = String(errores.length);
            const tbody = qs('#content-step-3 tbody');
            tbody.innerHTML = errores.slice(0,5).map(e=>`<tr class="border-t border-default bg-error/10"><td class="p-2 text-primary">${e.i+2}</td><td class="p-2 text-primary">${rows[e.i].matricula}</td><td class="p-2 text-primary">${rows[e.i].nombre} ${rows[e.i].apellidos}</td><td class="p-2 text-error font-medium">${e.error}</td></tr>`).join('');
          }, { once: true });

          byIdSel('btn-goto-step4')?.addEventListener('click', ()=>{
            // Importar: agregar estudiantes válidos
            const sel = qsa('#content-step-2 select');
            const map = { matricula: sel[0].value, nombre: sel[1].value, apellidos: sel[2].value };
            const idx = k => headers.indexOf(map[k]);
            const rows = parsed.map(r=>({ matricula: String(r[idx('matricula')]||'').trim(), nombre: String(r[idx('nombre')]||'').trim(), apellidos: String(r[idx('apellidos')]||'').trim() }));
            const existingMat = new Set(DataStore.state.students.map(s=>s.matricula));
            rows.forEach(r=>{
              if (!r.matricula || !r.nombre || !r.apellidos) return;
              if (existingMat.has(r.matricula)) return;
              DataStore.state.students.push({ id: uid('s'), matricula: r.matricula, nombre: r.nombre, apellidos: r.apellidos, grupos: [] });
            });
            DataStore.save();
          }, { once: true });
        }

        // ======= REPORTES =======
        function renderReportsPage(){
          const container = byIdSel('page-reportes'); if (!container) return;
          const totalStu = DataStore.state.students.length;
          const totalGrp = DataStore.state.groups.length;
          const totalAsis = DataStore.state.attendance.length;
          const totalGrades = DataStore.state.grades.length;
          container.innerHTML = `
            <h1 class="text-3xl font-bold text-primary">Reportes</h1>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="bg-surface p-6 rounded-2xl border border-default"><div class="text-secondary text-sm">Estudiantes</div><div class="text-3xl font-bold">${totalStu}</div></div>
              <div class="bg-surface p-6 rounded-2xl border border-default"><div class="text-secondary text-sm">Grupos</div><div class="text-3xl font-bold">${totalGrp}</div></div>
              <div class="bg-surface p-6 rounded-2xl border border-default"><div class="text-secondary text-sm">Registros de Asistencia</div><div class="text-3xl font-bold">${totalAsis}</div></div>
              <div class="bg-surface p-6 rounded-2xl border border-default"><div class="text-secondary text-sm">Registros de Calificaciones</div><div class="text-3xl font-bold">${totalGrades}</div></div>
            </div>
            <div class="mt-6 bg-surface p-6 rounded-2xl border border-default">
              <h3 class="text-lg font-semibold mb-4">Distribución de Promedios (último periodo por grupo)</h3>
              <div class="h-80"><canvas id="reportGradesChart"></canvas></div>
            </div>`;
          // Construir una serie simple: promedio general por grupo
          const labels = DataStore.state.groups.map(g=>g.nombre);
          const values = DataStore.state.groups.map(g=>{
            const gRecs = DataStore.state.grades.filter(x=>x.groupId===g.id);
            const last = gRecs[gRecs.length-1];
            if (!last) return 0;
            const arr = last.records||[]; if (!arr.length) return 0; return +(arr.reduce((a,b)=>a+(b.promedio||0),0)/arr.length).toFixed(1);
          });
          const isDark = document.documentElement.classList.contains('dark');
          const accent1 = isDark ? '#4FD1C5' : '#3EBBAF';
          setTimeout(()=>{
            const ctx = byIdSel('reportGradesChart'); if (!ctx || !window.Chart) return;
            new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Promedio', data: values, backgroundColor: accent1 }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ min:0, max:100 } } } });
          }, 0);
        }

        // Render inicial de páginas dependientes de datos si están activas
        if (!qs('#page-dashboard').classList.contains('hidden')) { /* dashboard por defecto */ }
      });
    </script>
  </body>
  </html>
